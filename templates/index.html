<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é¡”èªè¨¼æ¯”è¼ƒãƒ‡ãƒ¢ (DeepFace vs ONNX ArcFace)</title>
    <style>
        .comparison { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
            margin-top: 20px; 
        }
        .method { 
            border: 1px solid #ccc; 
            padding: 15px; 
            border-radius: 5px; 
            flex: 1; 
        }
        .method h3 { 
            margin-top: 0; 
        }
        .same { 
            color: green; 
            font-weight: bold; 
        }
        .different { 
            color: red; 
            font-weight: bold; 
        }
        .model-comparison-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        .ensemble-summary {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .model-card {
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
        }
        .model-card h4 {
            margin-top: 0;
            color: #495057;
        }
        .model-description {
            font-style: italic;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .search-results {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #28a745;
            border-radius: 10px;
            background-color: #f8fff9;
        }
        .result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: white;
        }
        .result-item.match {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .result-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        .result-details {
            flex: 1;
        }
        .similarity-score {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .similarity-score.high {
            color: #28a745;
        }
        .similarity-score.medium {
            color: #ffc107;
        }
        .similarity-score.low {
            color: #6c757d;
        }
        .rank-badge {
            display: inline-block;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            margin-right: 8px;
        }
        .rank-badge.top3 {
            background: linear-gradient(45deg, #ffd700, #ffb300);
            color: #333;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ ArcFaceãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒãƒ‡ãƒ¢ (DeepFace + ãƒãƒ«ãƒONNX)</h1>
    
    
    <!-- 1å¯¾Næ¯”è¼ƒ -->
    <div style="border: 1px solid #007bff; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #f8f9fa;">
        <h2>ğŸ” 1å¯¾N é¡”æ¤œç´¢</h2>
        <p style="color: #6c757d; margin-bottom: 15px;">1ã¤ã®ç”»åƒã¨ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ã¦ã®ç”»åƒã‚’æ¯”è¼ƒã—ã¾ã™</p>
        <form id="compare-folder-form" enctype="multipart/form-data">
            <label>æ¤œç´¢ã—ãŸã„é¡”ç”»åƒ: <input type="file" id="query-image" accept="image/*" required></label><br><br>
            <div style="margin-bottom: 15px;">
                <label>æ¯”è¼ƒå¯¾è±¡ã‚’é¸æŠ:</label><br>
                <input type="radio" id="select-files" name="selection-type" value="files" checked>
                <label for="select-files">å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (è¤‡æ•°é¸æŠå¯)</label><br>
                <input type="radio" id="select-folder" name="selection-type" value="folder">
                <label for="select-folder">ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ (ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ç”»åƒ)</label>
            </div>
            <div id="file-input-container">
                <label>æ¯”è¼ƒå¯¾è±¡ç”»åƒ: <input type="file" id="folder-images" accept="image/*" multiple required></label>
            </div>
            <div id="folder-input-container" style="display: none;">
                <label>æ¯”è¼ƒå¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€: <input type="file" id="folder-directory" webkitdirectory multiple accept="image/*"></label>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">
                    â€» ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã™ã‚‹ã¨ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ã¦ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã™
                </p>
            </div>
            <br>
            <button type="submit" id="compare-btn">æ¤œç´¢é–‹å§‹</button>
            <button type="button" id="cancel-btn" style="display: none; margin-left: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </form>
        
        <!-- é€²æ—è¡¨ç¤º -->
        <div id="progress-container" style="display: none; margin-top: 20px;">
            <div style="background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                <div id="progress-bar" style="background-color: #007bff; height: 20px; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="progress-text" style="margin-top: 10px; text-align: center;">å‡¦ç†ä¸­...</p>
        </div>
    </div>
    
    <!-- æ¤œç´¢çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="search-results" style="display: none;">
    </div>
    
    
    <script>
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
        document.querySelectorAll('input[name="selection-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const fileContainer = document.getElementById('file-input-container');
                const folderContainer = document.getElementById('folder-input-container');
                
                if (this.value === 'files') {
                    fileContainer.style.display = 'block';
                    folderContainer.style.display = 'none';
                    document.getElementById('folder-images').required = true;
                    document.getElementById('folder-directory').required = false;
                } else {
                    fileContainer.style.display = 'none';
                    folderContainer.style.display = 'block';
                    document.getElementById('folder-images').required = false;
                    document.getElementById('folder-directory').required = true;
                }
            });
        });

        document.getElementById('compare-folder-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const queryImage = document.getElementById('query-image').files[0];
            const selectionType = document.querySelector('input[name="selection-type"]:checked').value;
            
            let folderImages;
            if (selectionType === 'files') {
                folderImages = document.getElementById('folder-images').files;
            } else {
                folderImages = document.getElementById('folder-directory').files;
            }
            
            const compareBtn = document.getElementById('compare-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const searchResults = document.getElementById('search-results');
            
            if (!queryImage || folderImages.length === 0) {
                alert('æ¤œç´¢ç”»åƒã¨æ¯”è¼ƒå¯¾è±¡ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const imageFiles = Array.from(folderImages).filter(file => 
                file.type.startsWith('image/') || 
                /\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(file.name)
            );
            
            if (imageFiles.length === 0) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            compareBtn.disabled = true;
            compareBtn.textContent = 'å‡¦ç†ä¸­...';
            cancelBtn.style.display = 'inline-block';
            progressContainer.style.display = 'block';
            searchResults.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = `å‡¦ç†ä¸­... ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${imageFiles.length}`;
            
            try {
                const formData = new FormData();
                formData.append('query_image', queryImage);
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’é€ä¿¡
                for (let i = 0; i < imageFiles.length; i++) {
                    formData.append('folder_images', imageFiles[i]);
                }
                
                // å¤§é‡ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30 * 60 * 1000); // 30åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                console.log(`ğŸš€ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡: ${imageFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«`);
                console.log(`ğŸ“Š æ¨å®šãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${(imageFiles.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024).toFixed(1)}MB`);
                
                const response = await fetch('/compare_folder', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log(`ğŸ“¨ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡: status=${response.status}, ok=${response.ok}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`âŒ HTTPã‚¨ãƒ©ãƒ¼ ${response.status}:`, errorText);
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼ ${response.status}: ${errorText.substring(0, 200)}`);
                }
                
                const result = await response.json();
                console.log(`âœ… å‡¦ç†å®Œäº†: ${result.total_comparisons || 0}ä»¶å‡¦ç†`);
                
                displaySearchResults(result);
                progressContainer.style.display = 'none';
                
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                // UIã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
                compareBtn.disabled = false;
                compareBtn.textContent = 'æ¤œç´¢é–‹å§‹';
                cancelBtn.style.display = 'none';
                progressContainer.style.display = 'none';
            }
        });
        
        function displaySearchResults(data) {
            const searchResults = document.getElementById('search-results');
            
            const getSimilarityClass = (similarity) => {
                if (similarity > 0.7) return 'high';
                if (similarity > 0.45) return 'medium';
                return 'low';
            };
            
            let html = `
                <div class="search-results">
                    <h2>ğŸ” é¡”æ¤œç´¢çµæœ</h2>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px;">
                        <p><strong>æ¤œç´¢ç”»åƒ:</strong> ${data.query_image}</p>
                        <p><strong>æ¯”è¼ƒã—ãŸç”»åƒæ•°:</strong> ${data.total_comparisons.toLocaleString()}</p>
                        <p><strong>æˆåŠŸã—ãŸæ¯”è¼ƒ:</strong> ${data.successful_comparisons.toLocaleString()}</p>
                        <p><strong>ãƒãƒƒãƒã—ãŸç”»åƒ:</strong> ${data.matches_found.toLocaleString()}</p>
                        <p><strong>ä½¿ç”¨é–¾å€¤:</strong> ${data.processing_summary.threshold_used}</p>
                        <p><strong>ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:</strong> ${data.processing_summary.available_models.map(key => data.processing_summary.model_descriptions[key] || key).join(', ')}</p>
                        ${data.total_results > 0 ? `<p><strong>è¡¨ç¤ºçµæœ:</strong> å…¨ ${data.total_results.toLocaleString()} ä»¶è¡¨ç¤º</p>` : ''}
                        ${data.processing_summary.total_processing_time ? `<p><strong>ç·å‡¦ç†æ™‚é–“:</strong> ${(data.processing_summary.total_processing_time / 1000).toFixed(1)} ç§’</p>` : ''}
                        ${data.processing_summary.files_per_second ? `<p><strong>å‡¦ç†é€Ÿåº¦:</strong> ${data.processing_summary.files_per_second.toFixed(1)} ãƒ•ã‚¡ã‚¤ãƒ«/ç§’</p>` : ''}
                        ${data.processing_summary.multiprocessing_used ? `<p style="color: #28a745;"><strong>ğŸš€ é«˜åº¦æœ€é©åŒ–:</strong> ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚·ãƒ³ã‚°ä½¿ç”¨ (${data.processing_summary.max_workers_used}ä¸¦åˆ—)</p>` : ''}
                        ${data.total_comparisons > 1000 ? `<p style="color: #dc3545;"><strong>âš ï¸ å¤§é‡å‡¦ç†:</strong> ${data.total_comparisons.toLocaleString()}ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ</p>` : ''}
                    </div>
                    
                    <h3>ğŸ† çµæœ (é¡ä¼¼åº¦ä¸Šä½é †)</h3>
            `;
            
            data.results.forEach((result, index) => {
                const similarityClass = getSimilarityClass(result.best_similarity);
                const matchClass = result.is_match ? 'match' : '';
                
                html += `
                    <div class="result-item ${matchClass}">
                        ${result.image_path ? `<img src="${result.image_path}" alt="${result.filename}" class="result-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="result-image" style="background-color: #f8f9fa; display: none; align-items: center; justify-content: center; color: #6c757d;">ç”»åƒèª­è¾¼ã‚¨ãƒ©ãƒ¼<br><small>${result.image_path}</small></div>` : '<div class="result-image" style="background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">ç”»åƒãªã—</div>'}
                        <div class="result-details">
                            <h4>
                                <span class="rank-badge ${(result.rank || (index + 1)) <= 3 ? 'top3' : ''}">
                                    ${(result.rank || (index + 1)) <= 3 ? 'ğŸ†' : 'ğŸ“'} ç¬¬${result.rank || (index + 1)}ä½
                                </span>
                                ${result.original_filename || result.filename}
                            </h4>
                            <div class="similarity-score ${similarityClass}">
                                é¡ä¼¼åº¦: ${(result.best_similarity * 100).toFixed(1)}%
                            </div>
                            <p><strong>æœ€é«˜è©•ä¾¡ãƒ¢ãƒ‡ãƒ«:</strong> ${result.best_model}</p>
                            <p><strong>åˆ¤å®š:</strong> ${result.is_match ? 'âœ… ãƒãƒƒãƒ' : 'âŒ éãƒãƒƒãƒ'}</p>
                            ${result.error ? `<p class="error">ã‚¨ãƒ©ãƒ¼: ${result.error}</p>` : ''}
                            
                            <details style="margin-top: 10px;">
                                <summary>è©³ç´°çµæœ</summary>
                                <div style="margin-top: 10px;">
                                    ${Object.entries(result.model_results).map(([model_key, model_result]) => `
                                        <div style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                            <strong>${model_result.model_name}:</strong><br>
                                            é¡ä¼¼åº¦: ${(model_result.similarity * 100).toFixed(1)}%<br>
                                            ä¿¡é ¼åº¦: ${(model_result.confidence * 100).toFixed(1)}%<br>
                                            åˆ¤å®š: ${model_result.is_same ? 'åŒä¸€äººç‰©' : 'åˆ¥äºº'}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            searchResults.innerHTML = html;
            searchResults.style.display = 'block';
            
            // çµæœã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            searchResults.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html> 